#!/bin/bash

###SHELLPACK preamble tlbflush-install 0

###SHELLPACK parseargBegin
###SHELLPACK parseargEnd

mkdir -p $SHELLPACK_SOURCES/tlbflush-${VERSION}-installed
cd $SHELLPACK_SOURCES/tlbflush-${VERSION}-installed || die Failed to create install directory
wget -O tlbflush.c.in "http://marc.info/?l=linux-kernel&m=133727348217113&q=raw" || die Failed to download source code

START_LINE=`grep -n ^---$ tlbflush.c.in | cut -f1 -d:`
END_LINE=`grep -n ^--$ tlbflush.c.in | cut -f1 -d:`
head -$((END_LINE-1)) tlbflush.c.in | tail -$((END_LINE-START_LINE-1)) | grep -v "define FILE_SIZE" > tlbflush.c
gcc -DFILE_SIZE=$((128*1048576)) -O2 tlbflush.c -lpthread -o tlbflush || die Failed to build tlbflush binary

exit $SHELLPACK_SUCCESS

#!/bin/bash
# Run perf-bench futex benchmark

###SHELLPACK preamble futexbench-bench 3.16.3
TESTTIME=15
ITERATIONS=12
TESTLIST=

###SHELLPACK parseargBegin
###SHELLPACK parseargInstall
###SHELLPACK parseargParam   --workloads	WORKLOADS
###SHELLPACK parseargEnd

###SHELLPACK check_install_required futexbench-${VERSION}

# Include monitor hooks
. $SHELLPACK_INCLUDE/include-monitor.sh

PERF_DIR=$SHELLPACK_SOURCES/futexbench-${VERSION}-installed/tools/perf/
PERF_CMD=${PERF_DIR}/perf
FUTEX_THREADS="64 128 256 512 1024"

echo $WORKLOADS > $LOGDIR_RESULTS/workloads
for THREADS in $FUTEX_THREADS; do
    for WORKLOAD in $WORKLOADS; do
	mmtests_activity $WORKLOAD-$THREADS
	echo Running test $WORKLOAD
	monitor_pre_hook $LOGDIR_RESULTS $THREADS
	$PERF_CMD bench futex $WORKLOAD -t $THREADS 2>&1 | \
	    tee $LOGDIR_RESULTS/$WORKLOAD-${THREADS}.log \
	    || die Failed ro run perf-bench futex
	monitor_post_hook $LOGDIR_RESULTS $THREADS
    done
done

exit $SHELLPACK_SUCCESS

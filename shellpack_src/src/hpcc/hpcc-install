#!/bin/bash
###SHELLPACK preamble hpcc-install 1.5.0
WEB_LOCATION="http://icl.cs.utk.edu/projectsfiles/hpcc/download"
MIRROR_LOCATION="$WEBROOT/hpcc/"

install-depends openmpi openmpi-devel openmpi-libs libblas3 blas blas-devel blas-devel-static

###SHELLPACK parseargBegin
###SHELLPACK parseargEnd

TEMPLATE=Linux_PII_CBLAS

template_set_param() {
	KEY=$1
	VALUE=$2
	VALUE_ESCAPED=`echo "$VALUE" | sed -e 's/\//\\\\\//g'`
	sed -i -e "s/$KEY\s*=.*/$KEY = $VALUE_ESCAPED/" Make.$TEMPLATE
	grep MPdir Make.$TEMPLATE
}

###SHELLPACK sources_fetch hpcc-${VERSION}.tar.gz hpcc-$VERSION-installed
###SHELLPACK build_start hpcc-${VERSION}-installed
cd hpl || die Package is not laid out as expected
cp setup/Make.$TEMPLATE . || die Failed to copy $TEMPLATE template
template_set_param MPdir  $HPCC_MPI_PATH
template_set_param MPlib  ""
template_set_param LAdir  /usr/lib64
template_set_param LAinc  -I/usr/include
template_set_param LAlib  -lblas
template_set_param CC     $HPCC_MPI_PATH/mpicc
template_set_param LINKER $HPCC_MPI_PATH/mpicc
sed -i -e /HPL_CALL_CBLAS/d Make.$TEMPLATE

make arch=$TEMPLATE || die Failed to build hpcc stage 1
cd ..
make arch=$TEMPLATE || die Failed to build hpcc stage 2

exit $SHELLPACK_SUCCESS

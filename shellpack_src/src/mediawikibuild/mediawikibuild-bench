#!/bin/bash
###SHELLPACK preamble mediawikibuild-bench 1.18.6

###SHELLPACK parseargBegin
###SHELLPACK parseargInstall
###SHELLPACK parseargYes	--start		MEDIAWIKI_START
###SHELLPACK parseargYes	--stop		MEDIAWIKI_STOP
###SHELLPACK parseargEnd

###SHELLPACK check_install_required mediawikibuild-${VERSION}

# see install script
BUFF_POOL_SIZE=$(($MEMTOTAL_BYTES/2))
DBSTART_OPTIONS="--innodb_flush_method=nosync,--innodb_flush_log_at_trx_commit=0,--innodb_buffer_pool_size=${BUFF_POOL_SIZE},--innodb_log_file_size=512M,--max_allowed_packet=1G"

if [ "$MEDIAWIKI_START" = "yes" ]; then
    $SHELLPACK_INCLUDE/shellpack-bench-mariadbbuild --stop
    echo Starting mariadb server...
    $SHELLPACK_INCLUDE/shellpack-bench-mariadbbuild --start \
	--start_opts $DBSTART_OPTIONS \
	--effective_cachesize $((MEMTOTAL_BYTES*6/10)) \
	--shared_buffers $((MEMTOTAL_BYTES/4)) \
	--work_mem $((16*1048576)) || die Failed to start mariadb server.

    $SHELLPACK_INCLUDE/shellpack-bench-apachebuild --stop
    echo Starting apache server...
    $SHELLPACK_INCLUDE/shellpack-bench-apachebuild --start || die Failed to start apache http server.
fi

if [ "$MEDIAWIKI_STOP" = "yes" ]; then
    echo Stopping apache server...
    $SHELLPACK_INCLUDE/shellpack-bench-apachebuild --stop
    echo Stopping mariadb server...
    $SHELLPACK_INCLUDE/shellpack-bench-mariadbbuild --stop
fi

echo mediawikibuild successfully installed
exit $SHELLPACK_SUCCESS

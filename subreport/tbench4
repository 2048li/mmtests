echo
gendirlist tbench4
printheader

CLIENTS=`ls tbench4-$KERNEL_BASE/$TOPLEVEL/tbench-*.log | sed -e 's/.*\///' -e 's/tbench-//' -e 's/.log//' | sort -n`

# Generate plot files
for DIR in $DIRLIST; do
	INPUTS="$INPUTS `pwd`/$DIR/$TOPLEVEL/tbench.plot"
	TITLES="$TITLES `echo $DIR | sed -e 's/tbench4-//'`"
	echo -n > $DIR/$TOPLEVEL/tbench.plot
	echo -n > $DIR/$TOPLEVEL/tbench-latency.plot
	for CLIENT in $CLIENTS; do
		echo $CLIENT `grep execute $DIR/$TOPLEVEL/tbench-$CLIENT.log | awk '{print $3}' | mean` >> $DIR/$TOPLEVEL/tbench.plot
		echo $CLIENT `grep execute $DIR/$TOPLEVEL/tbench-$CLIENT.log | awk '{print $9}' | mean` >> $DIR/$TOPLEVEL/tbench-latency.plot
	done
done

echo TBench 4 Throughput
for PROCESS in min mean stddev max; do
for CLIENT in $CLIENTS; do
	printf "%-7s %3d %-6s" Clients $CLIENT $PROCESS
	VANILLA=`grep execute tbench4-$KERNEL_BASE/$TOPLEVEL/tbench-$CLIENT.log | awk '{print $3}' | $PROCESS`

	for DIR in $DIRLIST; do
		RESULT=`grep execute $DIR/$TOPLEVEL/tbench-$CLIENT.log | awk '{print $3}' | $PROCESS`
		printf " %7.2f (%6.2f%%)" $RESULT `pdiff $RESULT $VANILLA`
	done
	echo

	if [ "$PROCESS" = "mean" ]; then
		printf "%-17s" "+/-"
		for DIR in $DIRLIST; do
			MEAN=`grep execute $DIR/$TOPLEVEL/tbench-$CLIENT.log | awk '{print $3}' | mean`
			STDDEV=`grep execute $DIR/$TOPLEVEL/tbench-$CLIENT.log | awk '{print $3}' | stddev`
			printf " %7.2f%%         " `perl -e "print ($STDDEV*100/$MEAN)"`
		done
		echo
		printf "%-7s %3s %-6s" "" "" true
		VANILLA=`grep execute tbench4-$KERNEL_BASE/$TOPLEVEL/tbench-$CLIENT.log | awk '{print $3}' | $PROCESS`
		for DIR in $DIRLIST; do
			RESULT=`grep execute $DIR/$TOPLEVEL/tbench-$CLIENT.log | awk '{print $3}' | $PROCESS`
			printf " %7.2f (%6.2f%%)" $RESULT `pdiff $RESULT $VANILLA`
		done
		echo
	fi
done
done

# Latency
echo
echo TBench 4 Latency
for PROCESS in min mean stddev max; do
for CLIENT in $CLIENTS; do
	printf "%-7s %3d %-6s" Clients $CLIENT $PROCESS
	VANILLA=`grep execute tbench4-$KERNEL_BASE/$TOPLEVEL/tbench-$CLIENT.log | awk '{print $9}' | $PROCESS`

	for DIR in $DIRLIST; do
		RESULT=`grep execute $DIR/$TOPLEVEL/tbench-$CLIENT.log | awk '{print $9}' | $PROCESS`
		printf " %7.2f (%6.2f%%)" $RESULT `pndiff $RESULT $VANILLA`
	done
	echo
done
done

echo
gendirlist dbench4
printheader

CLIENTS=`ls dbench4-$KERNEL_BASE/$TOPLEVEL/dbench-*.log | sed -e 's/.*\///' -e 's/dbench-//' -e 's/.log//' | sort -n`

# Generate plot file stubs
for DIR in $DIRLIST; do
	INPUTS="$INPUTS `pwd`/$DIR/$TOPLEVEL/dbench4-DBENCHDATA.plot"
	TITLES="$TITLES `echo $DIR | sed -e 's/dbench4-//'`"
	for CLIENT in $CLIENTS; do
		echo -n > $DIR/$TOPLEVEL/dbench4-candle-tput-$CLIENT.plot
		echo -n > $DIR/$TOPLEVEL/dbench4-candle-latency-$CLIENT.plot
	done
	echo -n > $DIR/$TOPLEVEL/dbench4-tput-mean.plot
	echo -n > $DIR/$TOPLEVEL/dbench4-latency-mean.plot
	echo -n > $DIR/$TOPLEVEL/dbench4-tput-ratio.plot
	echo -n > $DIR/$TOPLEVEL/dbench4-latency-ratio.plot
done

echo DBench 4 Throughput
for PROCESS in min mean stddev max; do
for CLIENT in $CLIENTS; do
	printf "%-7s %3d %-6s" Clients $CLIENT $PROCESS
	VANILLA=`grep execute dbench4-$KERNEL_BASE/$TOPLEVEL/dbench-$CLIENT.log | awk '{print $3}' | $PROCESS`

	for DIR in $DIRLIST; do
		RESULT=`grep execute $DIR/$TOPLEVEL/dbench-$CLIENT.log | awk '{print $3}' | $PROCESS`
		printf " %7.2f (%6.2f%%)" $RESULT `pdiff $RESULT $VANILLA`
	done
	echo

	if [ "$PROCESS" = "mean" ]; then
		printf "%-17s" "+/-"
		for DIR in $DIRLIST; do
			MEAN=`grep execute $DIR/$TOPLEVEL/dbench-$CLIENT.log | awk '{print $3}' | mean`
			STDDEV=`grep execute $DIR/$TOPLEVEL/dbench-$CLIENT.log | awk '{print $3}' | stddev`
			printf " %7.2f%%         " `perl -e "print ($STDDEV*100/$MEAN)"`
		done
		echo
	fi
done
done

# Latency
echo
echo DBench 4 Latency
for PROCESS in min mean stddev max; do
for CLIENT in $CLIENTS; do
	printf "%-7s %3d %-6s" Clients $CLIENT $PROCESS
	VANILLA=`grep execute dbench4-$KERNEL_BASE/$TOPLEVEL/dbench-$CLIENT.log | awk '{print $9}' | $PROCESS`

	for DIR in $DIRLIST; do
		RESULT=`grep execute $DIR/$TOPLEVEL/dbench-$CLIENT.log | awk '{print $9}' | $PROCESS`
		printf " %7.2f (%6.2f%%)" $RESULT `pndiff $RESULT $VANILLA`
	done
	echo
done
done

# Operations
echo
echo DBench 4 Operation Latency
for OPERATION in Deltree Flush Close LockX Mkdir Rename ReadX WriteX Unlink UnlockX FIND_FIRST SET_FILE_INFORMATION QUERY_FILE_INFORMATION QUERY_PATH_INFORMATION QUERY_FS_INFORMATION NTCreateX; do
for CLIENT in $CLIENTS; do
	printf "%-7s %3d %-6s" Clients $CLIENT $OPERATION
	VANILLA=`grep -A 20 "^ Operation" dbench4-$KERNEL_BASE/$TOPLEVEL/dbench-$CLIENT.log | grep " $OPERATION " | awk '{print $3}'`
	for DIR in $DIRLIST; do
		RESULT=`grep -A 20 "^ Operation" $DIR/$TOPLEVEL/dbench-$CLIENT.log | grep " $OPERATION " | awk '{print $3}'`
		printf " %7.2f (%6.2f%%)" $RESULT `pndiff $RESULT $VANILLA`
	done
	echo
done
done

# Generate something useful as a plot for throughput
OFFSET=0
for DIR in $DIRLIST; do
for CLIENT in $CLIENTS; do
	MIN=`grep execute $DIR/$TOPLEVEL/dbench-$CLIENT.log | awk '{print $3}' | min`
	MAX=`grep execute $DIR/$TOPLEVEL/dbench-$CLIENT.log | awk '{print $3}' | max`
	MEAN=`grep execute $DIR/$TOPLEVEL/dbench-$CLIENT.log | awk '{print $3}' | mean`
	STDDEV=`grep execute $DIR/$TOPLEVEL/dbench-$CLIENT.log | awk '{print $3}' | stddev`

	LOW_STDDEV=`perl -e "print $MEAN-$STDDEV"`
	HIGH_STDDEV=`perl -e "print $MEAN+$STDDEV"`
	HIGH_STDDEV=`echo "$MAX
$HIGH_STDDEV" | min`
	LOW_STDDEV=`echo "$STDDEV
$LOW_STDDEV" | max`
	echo $OFFSET $LOW_STDDEV $MIN $MAX $HIGH_STDDEV $MEAN \# stddev=$STDDEV > $DIR/$TOPLEVEL/dbench4-candle-tput-$CLIENT.plot
	echo $CLIENT $MEAN >> $DIR/$TOPLEVEL/dbench4-tput-mean.plot
done
OFFSET=$(($OFFSET+1))
done

# Generate something useful as a plot for latency
OFFSET=0
for DIR in $DIRLIST; do
for CLIENT in $CLIENTS; do
	MIN=`grep execute $DIR/$TOPLEVEL/dbench-$CLIENT.log | awk '{print $9}' | min`
	MAX=`grep execute $DIR/$TOPLEVEL/dbench-$CLIENT.log | awk '{print $9}' | max`
	MEAN=`grep execute $DIR/$TOPLEVEL/dbench-$CLIENT.log | awk '{print $9}' | mean`
	STDDEV=`grep execute $DIR/$TOPLEVEL/dbench-$CLIENT.log | awk '{print $9}' | stddev`

	LOW_STDDEV=`perl -e "print $MEAN-$STDDEV"`
	HIGH_STDDEV=`perl -e "print $MEAN+$STDDEV"`
	HIGH_STDDEV=`echo "$MAX
$HIGH_STDDEV" | min`
	LOW_STDDEV=`echo "$STDDEV
$LOW_STDDEV" | max`
	echo $OFFSET $LOW_STDDEV $MIN $MAX $HIGH_STDDEV $MEAN \# stddev=$STDDEV > $DIR/$TOPLEVEL/dbench4-candle-latency-$CLIENT.plot
	echo $CLIENT $MEAN >> $DIR/$TOPLEVEL/dbench4-latency-mean.plot
done
OFFSET=$(($OFFSET+1))
done
